# ü§ñ Architecture.md: AI Telegram –ë–æ—Ç —Å OpenRouter

## 1. –û–±–∑–æ—Ä –ü—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π Telegram-–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API **OpenRouter** –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–Ω–æ–∂–µ—Å—Ç–≤—É –∫—Ä—É–ø–Ω–æ–º–∞—Å—à—Ç–∞–±–Ω—ã—Ö —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π (LLM) –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (–ü—Ä–∏–º–µ—Ä):** Python (aiogram/python-telegram-bot), FastAPI/Flask, OpenRouter API.

## 2. –õ–æ–≥–∏—á–µ—Å–∫–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∏—Ç—Å—è –Ω–∞ —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏:

| –£—Ä–æ–≤–µ–Ω—å | –û–ø–∏—Å–∞–Ω–∏–µ | –û—Å–Ω–æ–≤–Ω—ã–µ –ó–∞–¥–∞—á–∏ |
| :--- | :--- | :--- |
| **I. –£—Ä–æ–≤–µ–Ω—å –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Telegram)** | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—Ä–∏–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π. | –ü—Ä–∏–µ–º –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (Updates), –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (`sendMessage`), –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (`/start`, `/help`). |
| **II. –£—Ä–æ–≤–µ–Ω—å –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (–°–µ—Ä–≤–µ—Ä –ë–æ—Ç–∞)** | –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π –∑–∞–ø—Ä–æ—Å–æ–≤. | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–∏–∞–ª–æ–≥–æ–≤ (—Å–µ—Å—Å–∏–π), —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenRouter, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫. |
| **III. –£—Ä–æ–≤–µ–Ω—å –°–µ—Ä–≤–∏—Å–æ–≤ (OpenRouter/DB)** | –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ LLM (—á–µ—Ä–µ–∑ OpenRouter), —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤ (DB). |

---

## 3. –§–∏–∑–∏—á–µ—Å–∫–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –§–∞–π–ª–æ–≤ –∏ –ö–∞—Ç–∞–ª–æ–≥–æ–≤

–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Python):

/ai_telegram_bot ‚îú‚îÄ‚îÄ .env # üîë –§–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è (API_KEY, BOT_TOKEN) ‚îú‚îÄ‚îÄ requirements.txt # üì¶ –°–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python ‚îú‚îÄ‚îÄ Dockerfile # üê≥ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) ‚îú‚îÄ‚îÄ Architecture.md # üìÑ –≠—Ç–æ—Ç —Ñ–∞–π–ª ‚îú‚îÄ‚îÄ README.md # üìñ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø—É—Å–∫—É ‚îÇ ‚îú‚îÄ‚îÄ main.py # üöÄ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞) ‚îÇ ‚îú‚îÄ‚îÄ /core ‚îÇ ‚îú‚îÄ‚îÄ config.py # ‚öôÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –æ–±—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚îÇ ‚îî‚îÄ‚îÄ exceptions.py # ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è ‚îÇ ‚îú‚îÄ‚îÄ /bot ‚îÇ ‚îú‚îÄ‚îÄ handlers.py # üì§ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π (e.g., /start, text_messages) ‚îÇ ‚îú‚îÄ‚îÄ middlewares.py # üõ°Ô∏è –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û (e.g., rate limiting, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è) ‚îÇ ‚îî‚îÄ‚îÄ init.py ‚îÇ ‚îú‚îÄ‚îÄ /services ‚îÇ ‚îú‚îÄ‚îÄ openrouter_client.py # üåê –ö–ª–∞—Å—Å/–º–æ–¥—É–ª—å –¥–ª—è HTTP-–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å OpenRouter API ‚îÇ ‚îú‚îÄ‚îÄ history_manager.py # üí¨ –ú–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–∞ (Session/Context) ‚îÇ ‚îî‚îÄ‚îÄ init.py ‚îÇ ‚îî‚îÄ‚îÄ /storage (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚îú‚îÄ‚îÄ database.py # üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î (e.g., Redis, SQLite) ‚îî‚îÄ‚îÄ models.py # üß± –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ORM)

## 4. –û–ø–∏—Å–∞–Ω–∏–µ –ö–ª—é—á–µ–≤—ã—Ö –ú–æ–¥—É–ª–µ–π

### 4.1. `main.py`

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Telegram-–±–æ—Ç–∞, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ `/bot`. –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å Long Polling –∏–ª–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Webhook.

### 4.2. `/core/config.py`

–ë–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç `TELEGRAM_BOT_TOKEN` –∏ `OPENROUTER_API_KEY` –∏–∑ —Ñ–∞–π–ª–∞ `.env` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.

### 4.3. `/bot/handlers.py`

–°–æ–¥–µ—Ä–∂–∏—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π:

* **`/start`**: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
* **–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**: –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞. –í—ã–∑—ã–≤–∞–µ—Ç `history_manager` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ `openrouter_client`, –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç.

### 4.4. `/services/openrouter_client.py`

–≠—Ç–æ —Å–µ—Ä–¥—Ü–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å LLM. –ö–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–µ—Ç–æ–¥ `generate_response(messages: list[dict])`, –∫–æ—Ç–æ—Ä—ã–π:

1.  –§–æ—Ä–º–∏—Ä—É–µ—Ç JSON-—Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–µ–π OpenRouter (–ø–æ–ª–µ `messages` –≤–∫–ª—é—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ).
2.  –í—ã–ø–æ–ª–Ω—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `https://openrouter.ai/api/v1/chat/completions`.
3.  –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç, –∏–∑–≤–ª–µ–∫–∞—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.

### 4.5. `/services/history_manager.py`

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ **–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** –¥–∏–∞–ª–æ–≥–∞. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –æ–Ω –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –ø–∞—Ä "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–±–æ—Ç" –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, —á—Ç–æ–±—ã LLM –ø–æ–º–Ω–∏–ª–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–ø–ª–∏–∫–∏. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞, –æ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—É—é –ø–∞—Ä—É –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

---

## 5. –ü–æ—Ç–æ–∫–∏ –î–∞–Ω–Ω—ã—Ö

1.  **–í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:** `Telegram Update` $\rightarrow$ `main.py` $\rightarrow$ `handlers.py`.
2.  **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞:** `handlers.py` $\rightarrow$ `history_manager.py` (–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç) $\rightarrow$ `openrouter_client.py` (–°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å).
3.  **–ò—Å—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç:** `openrouter_client.py` (–û—Ç–≤–µ—Ç LLM) $\rightarrow$ `history_manager.py` (–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç) $\rightarrow$ `handlers.py` $\rightarrow$ `Telegram Bot API` (–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é).